

# 通用模块设计及编码



## common模块简介

common模块主要作用是为其他模块提供可以复用的对象，通用模块中不涉及业务逻辑的编码。一般用来封装通用的响应，通用分页参数，提供基础的异常封装等。



## blog-common-core

> 通用核心模块，进行通用对象的编码



### i18n国际化

使用SpringBoot提供的国际化功能进行错误信息的获取

- 在resources目录下新增国际化语言文件

```bash
# messages.properties
welcome=欢迎使用{0}(默认)

# messages_en_US.properties
welcome=welcome to use {0}(english)

# messages_zh_CN.properties
welcome=欢迎使用{0}(中文)
```



- 配置国际化参数

```yaml
spring:
  # i18n 国际化
  messages:
    encoding: utf-8
```



- 编写组件进行使用

```java
@Component
public class I18nUtils {

    @Autowired
    private MessageSource messageSource;

    /**
     * 获取国际化翻译值
     * @param msgKey 消息key
     * @param msgArgs 消息参数
     * @return 翻译内容
     */
    public String get(String msgKey, Object[] msgArgs) {
        try {
            return messageSource.getMessage(msgKey, msgArgs, LocaleContextHolder.getLocale());
        } catch (Exception e) {
            return msgKey;
        }
    }
}
```

- 封装基础异常类，后续业务异常继承该类

```java
@Data
@EqualsAndHashCode(callSuper = true)
public class BaseException extends RuntimeException {

    @Autowired
    I18nUtils i18nUtils;

    /**
     * 所属模块
     */
    private String module;

    /**
     * 错误码
     */
    private Integer code;

    /**
     * 错误码对应的参数
     */
    private Object[] args;

    /**
     * 错误消息
     */
    private String defaultMessage;

    public BaseException(String module, Integer code, Object[] args, String defaultMessage)
    {
        this.module = module;
        this.code = code;
        this.args = args;
        this.defaultMessage = defaultMessage;
    }

    public BaseException(String module, Integer code, Object[] args)
    {
        this(module, code, args, null);
    }

    public BaseException(String module, String defaultMessage)
    {
        this(module, null, null, defaultMessage);
    }

    public BaseException(Integer code, Object[] args)
    {
        this(null, code, args, null);
    }

    public BaseException(String defaultMessage)
    {
        this(null, null, null, defaultMessage);
    }

    @Override
    public String getMessage() {
        String message = null;
        if (Objects.nonNull(code))
        {
            message = i18nUtils.get(String.valueOf(code), args);
        }
        if (message == null)
        {
            message = defaultMessage;
        }
        return message;
    }
}
```



### 通用响应对象

- 定义通用响应结果枚举类型，提高代码可读性

```java
public enum BaseRespCode {
    OK(200,"操作成功"),
    UNAUTHORIZED(401,"权限校验失败"),
    INTERNAL_SERVER_ERROR(500, "服务器内部异常"),
    SERVICE_UNAVAILABLE(503,"服务不可用")
    ;

    /**
     * 响应码
     */
    private final Integer code;
    /**
     * 响应消息
     */
    private final String message;

    BaseRespCode(int code, String message) {
        this.code = code;
        this.message = message;
    }

    public Integer getCode() {
        return code;
    }

    public String getMessage() {
        return message;
    }
}
```



- 封装通过响应对象

```java
@Data
public class R<T> {
    private Integer code = 200;
    private String message;
    private T data;

    /**
     * 成功响应
     *
     * @param data 数据
     * @param <T>  泛型
     * @return 响应
     */
    public static <T> R<T> ok(T data) {
        R<T> r = new R<>();
        r.setMessage("操作成功");
        r.setData(data);
        return r;
    }

    /**
     * 成功响应
     *
     * @param message 消息
     * @param <T>     泛型
     * @return 响应
     */
    public static <T> R<T> ok(String message) {
        R<T> r = new R<>();
        r.setMessage(message);
        return r;
    }


    /**
     * 成功响应
     *
     * @param message 消息
     * @param data    数据
     * @param <T>     泛型
     * @return 响应
     */
    public static <T> R<T> ok(String message, T data) {
        R<T> r = new R<>();
        r.setMessage(message);
        r.setData(data);
        return r;
    }

    /**
     * 失败响应
     *
     * @param message 消息
     * @param <T>     泛型
     * @return 响应
     */
    public static <T> R<T> fail(String message) {
        R<T> r = new R<>();
        r.setCode(-1);
        r.setMessage(message);
        return r;
    }

    /**
     * 失败响应
     *
     * @param message 消息
     * @param data    数据
     * @param <T>     泛型
     * @return 响应
     */
    public static <T> R<T> fail(String message, T data) {
        R<T> r = new R<>();
        r.setCode(-1);
        r.setMessage(message);
        r.setData(data);
        return r;
    }

    /**
     * 失败响应
     *
     * @param code    响应码
     * @param message 消息
     * @param data    数据
     * @param <T>     泛型
     * @return 响应
     */
    public static <T> R<T> fail(Integer code, String message, T data) {
        R<T> r = new R<>();
        r.setCode(code);
        r.setMessage(message);
        r.setData(data);
        return r;
    }

    /**
     * 失败响应
     * @param baseRespCode 通用响应枚举
     * @param <T> 泛型
     * @return 响应
     */
    public static <T> R<T> fail(BaseRespCode baseRespCode) {
        return fail(baseRespCode.getCode(), baseRespCode.getMessage(), null);
    }
}
```



## blog-common-db

> 定义数据库相关的依赖，依赖数据库操作的模块直接依赖此模块即可

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>blog-common</artifactId>
        <groupId>cn.leithda</groupId>
        <version>1.0</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>
    <description>
        数据库依赖
    </description>

    <artifactId>blog-common-db</artifactId>

    <dependencies>
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
        </dependency>

        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid</artifactId>
        </dependency>

        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>
    </dependencies>

</project>
```



## blog-common-nacos

> 定义Nacos注册中心及配置中心配置。使用其他注册中心或配置中心时不依赖此模块

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>blog-common</artifactId>
        <groupId>cn.leithda</groupId>
        <version>1.0</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>
    <description>
        Nacos注册及配置中心
    </description>

    <artifactId>blog-common-nacos</artifactId>

    <dependencies>
        <!-- Nacos 配置中心 -->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
        </dependency>
        <!-- Nacos 注册中心 -->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
        </dependency>
    </dependencies>

</project>
```

